<!DOCTYPE html>
<html>
  <head>
    <title>Capture Photo</title>
	<script src="http://code.jquery.com/jquery-1.10.2.min.js" type="text/javascript"></script>
	<script src="Blob.js" type="text/javascript"></script>
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script type="text/javascript" charset="utf-8">

    var pictureSource;   // picture source
    var destinationType; // sets the format of returned value

    // Wait for device API libraries to load
    //
    document.addEventListener("deviceready",onDeviceReady,false);

    // device APIs are available
    //
    function onDeviceReady() {

    }

	function writeData(data){
		//provo a salvare l'immagine in una cartella sul file system
      	window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function (fileSystem){
      	// funzione chiamata in caso sia stato ottenuto un filesystem con successo
		// creo una directory (se non esiste gi√†) nella quale salvare l'immagine scattata dalla fotocamera
		console.log("FileSystem ottenuto. Nome fileSystem: " + fileSystem.name);
      	fileSystem.root.getDirectory("saveLocal", {create: true}, function(parent){
      		// funzione chiamata in caso sia stato possibile creare la directory
			// salvo l'immagine in questa dir
			console.log("Directory aperta/creata");
			var d = new Date();
      		var n = d.getTime();
      		//new file name
      		var newFileName = n + ".txt";
      		/* crea un file con nome newFileName */
			fileSystem.root.getFile(newFileName, {create: true}, function(fileEntry){
				console.log("creato file per contenere foto: " + fileEntry.name);
				
          		fileEntry.createWriter(function (writer){
          			writer.onwriteend = function (evt){
				      console.log("Scrittura file completata");
          			};
					writer.onerror = function (evt){
						console.log("scrittura fallita");
						console.log(evt.target.error);
					};

          			writer.write(data);
          			
          			/*var b = new Blob(["Caro amico ti scrivo"], {type: "text/plain;charset=UTF-8"});*/
          		}, onWriterError);
				fileEntry.moveTo(parent, newFileName, function(newFileEntry){
					console.log("file salvato con nome: " + newFileEntry.name);
				}, onMoveFileError);
			}, onResolveError);
      	}, onGetDirectoryFail);
      }, onFileSystemError);
	}
	
	function str2ab(str) {
	  var buf = new ArrayBuffer(str.length);
	  var bufView = new Int8Array(buf);
	  for (var i=0, strLen=str.length; i<strLen; i++) {
	    bufView[i] = str.charCodeAt(i);
	  }
	  return buf;
    }
    </script>
  </head>
  <body>
	<button onclick='writeData("Sono riuscito a scrivere in un file");'>Scarica immagine da couchdb</button>
  </body>
</html>